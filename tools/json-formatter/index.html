<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON æ ¼å¼åŒ–/å‹ç¼©å·¥å…· - å·¥å…·é›†åˆ</title>
    <link rel="stylesheet" href="/assets/css/common.css">
    <style>
        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* è¿”å›é¦–é¡µé“¾æ¥ */
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--primary);
        }

        /* Header */
        header {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            flex-shrink: 0;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .title-area {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .icon-box {
            background-color: var(--primary);
            color: white;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            display: flex;
        }

        h1 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .subtitle {
            margin: 0;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .controls {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
            flex-wrap: wrap;
        }

        /* æŒ‰é’®åˆ†ç»„ */
        .btn-group {
            display: flex;
            gap: var(--spacing-xs);
            align-items: center;
            padding: 0 var(--spacing-xs);
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }

        .btn-group:first-of-type {
            border-left: none;
        }

        .btn-group:last-of-type {
            border-right: none;
        }

        /* Main Content */
        main {
            flex: 1;
            padding: var(--spacing-md);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        /* åŒæ å¸ƒå±€ */
        .editor-view {
            flex: 1;
            display: flex;
            gap: var(--spacing-md);
            min-height: 0;
        }

        .editor-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            min-height: 0;
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
            font-size: 0.875rem;
            font-weight: 600;
        }

        .editor-actions {
            display: flex;
            gap: var(--spacing-xs);
            align-items: center;
        }

        .action-btn-small {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--border-radius-sm);
            transition: all 0.2s;
            font-weight: 500;
        }

        .action-btn-small:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--primary);
        }

        .action-btn-small .icon {
            width: 14px;
            height: 14px;
        }

        .status-bar {
            padding: var(--spacing-xs) var(--spacing-md);
            background-color: rgba(0,0,0,0.02);
            border-top: 1px solid var(--border-color);
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .textarea-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            overflow: hidden;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-primary);
        }

        .line-numbers {
            width: 3rem;
            background-color: rgba(0,0,0,0.02);
            border-right: 1px solid var(--border-color);
            text-align: right;
            padding: var(--spacing-md) var(--spacing-sm);
            font-family: var(--font-mono);
            font-size: 0.875rem;
            line-height: 1.5rem;
            color: var(--text-muted);
            user-select: none;
            overflow: hidden;
        }

        .code-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .code-overlay, textarea {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: var(--spacing-md);
            margin: 0;
            border: none;
            background: transparent;
            font-family: var(--font-mono);
            font-size: 0.875rem;
            line-height: 1.5rem;
            white-space: pre;
            overflow: auto;
        }

        .code-overlay {
            pointer-events: none;
            color: var(--text-primary);
            z-index: 1;
        }

        textarea {
            color: transparent;
            caret-color: var(--text-primary);
            z-index: 2;
            resize: none;
            outline: none;
        }

        /* åªè¯»è¾“å‡ºåŒºåŸŸ */
        .output-readonly textarea {
            cursor: text;
            user-select: text;
        }

        .output-readonly textarea:focus {
            outline: none;
        }


        .status-valid {
            color: var(--success-text);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .status-invalid {
            color: var(--error-text);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        /* è¾“å‡ºå†…å®¹åŒºåŸŸ */
        .output-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .output-content.hidden {
            display: none;
        }

        /* é”™è¯¯é¢æ¿ - å³ä¾§æ˜¾ç¤ºï¼Œç°ä»£åŒ–å¡ç‰‡è®¾è®¡ */
        .error-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            padding: var(--spacing-lg);
            overflow-y: auto;
            animation: slideInRight 0.3s ease-out;
            background: linear-gradient(135deg, rgba(153, 27, 27, 0.02) 0%, transparent 100%);
        }

        .error-panel.hidden {
            display: none;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .error-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            border: 2px solid var(--error-text);
            box-shadow: 0 4px 20px rgba(153, 27, 27, 0.2), 0 0 0 1px rgba(153, 27, 27, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: box-shadow 0.3s ease;
        }

        .error-card:hover {
            box-shadow: 0 6px 24px rgba(153, 27, 27, 0.25), 0 0 0 1px rgba(153, 27, 27, 0.15);
        }

        .error-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: linear-gradient(90deg, var(--error-bg) 0%, transparent 100%);
            border-bottom: 1px solid rgba(153, 27, 27, 0.1);
        }

        .error-icon-wrapper {
            flex-shrink: 0;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: var(--error-text);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .error-icon-wrapper svg {
            width: 1.25rem;
            height: 1.25rem;
        }

        .error-title-section {
            flex: 1;
            min-width: 0;
        }

        .error-title {
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--error-text);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .error-location-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.125rem 0.5rem;
            background: var(--error-text);
            color: white;
            border-radius: 0.75rem;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: var(--spacing-xs);
        }

        .error-body {
            padding: var(--spacing-md);
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .error-message {
            color: var(--text-primary);
            font-size: 0.8125rem;
            line-height: 1.6;
            margin-bottom: var(--spacing-sm);
            font-family: var(--font-mono);
            background: var(--bg-secondary);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            border-left: 3px solid var(--error-text);
        }

        .error-suggestion {
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid rgba(153, 27, 27, 0.2);
        }

        .error-suggestion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            padding: var(--spacing-xs) 0;
        }

        .error-suggestion-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--error-text);
        }

        .error-suggestion-icon {
            transition: transform 0.2s;
            width: 0.875rem;
            height: 0.875rem;
        }

        .error-suggestion.expanded .error-suggestion-icon {
            transform: rotate(180deg);
        }

        .error-suggestion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding-top: var(--spacing-sm);
        }

        .error-suggestion.expanded .error-suggestion-content {
            max-height: 200px;
        }

        .error-suggestion-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.6;
            padding: var(--spacing-sm);
            background: var(--bg-secondary);
            border-radius: var(--border-radius-sm);
        }

        .error-action-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: 0.375rem 0.75rem;
            margin-top: var(--spacing-sm);
            background: var(--error-text);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .error-action-btn:hover {
            background: #7f1d1d;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(153, 27, 27, 0.3);
        }

        /* é”™è¯¯è¡Œé«˜äº® - å¢å¼ºç‰ˆ */
        .line-numbers .error-line {
            background: linear-gradient(90deg, var(--error-bg) 0%, transparent 100%);
            color: var(--error-text);
            font-weight: 700;
            padding-right: var(--spacing-sm);
            position: relative;
        }

        .line-numbers .error-line::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--error-text);
        }

        .code-overlay .error-line {
            background: linear-gradient(90deg, rgba(153, 27, 27, 0.08) 0%, transparent 100%);
            display: block;
            padding: 0 var(--spacing-md);
            margin: 0 calc(-1 * var(--spacing-md));
            border-left: 3px solid var(--error-text);
            position: relative;
        }

        /* é”™è¯¯å­—ç¬¦æ ‡è®° - çº¢è‰²æ³¢æµªçº¿ */
        .code-overlay .error-char {
            position: relative;
            background: rgba(153, 27, 27, 0.15);
            border-bottom: 2px wavy var(--error-text);
            padding: 0 1px;
        }

        /* é”™è¯¯ä½ç½®æ ‡è®° - æ›´é†’ç›®çš„æ ‡è®° */
        .error-marker {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--error-text);
            border-radius: 50%;
            border: 2px solid var(--bg-primary);
            box-shadow: 0 0 0 2px var(--error-text);
            pointer-events: none;
            z-index: 3;
            animation: errorPulse 1.5s infinite;
        }

        @keyframes errorPulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.2);
            }
        }

        .editor-container.error .textarea-wrapper {
            border-color: var(--error-text);
            box-shadow: 0 0 0 2px rgba(153, 27, 27, 0.15), 0 0 0 4px rgba(153, 27, 27, 0.05);
            animation: errorShake 0.5s ease-out;
        }

        @keyframes errorShake {
            0%, 100% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-4px);
            }
            75% {
                transform: translateX(4px);
            }
        }

        /* é”™è¯¯æ‚¬åœæç¤º */
        .error-tooltip {
            position: absolute;
            background: var(--error-text);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius-sm);
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.2s ease-out;
        }

        .error-tooltip::before {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 1rem;
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid var(--error-text);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Syntax Highlighting */
        .hl-key { color: #2563eb; font-weight: 600; }
        .hl-string { color: #16a34a; }
        .hl-number { color: #9333ea; }
        .hl-bool { color: #ea580c; }
        .hl-null { color: #6b7280; }

        @media (prefers-color-scheme: dark) {
            .hl-key { color: #60a5fa; }
            .hl-string { color: #4ade80; }
            .hl-number { color: #c084fc; }
            .hl-bool { color: #fb923c; }
        }

        /* å“åº”å¼ï¼šç§»åŠ¨ç«¯æ”¹ä¸ºä¸Šä¸‹å¸ƒå±€ */
        @media (max-width: 768px) {
            .editor-view {
                flex-direction: column;
            }
        }

        .icon {
            width: 1em;
            height: 1em;
            display: inline-block;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-top">
            <div>
                <a href="/" class="back-link">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                    è¿”å›å·¥å…·åˆ—è¡¨
                </a>
                <div class="title-area">
                    <div class="icon-box">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                    </div>
                    <div>
                        <h1>JSON å¤„ç†å·¥å…·</h1>
                        <p class="subtitle">æ ¼å¼åŒ–ã€å‹ç¼©ã€è½¬ä¹‰ã€åè½¬ä¹‰ JSON æ•°æ®</p>
                    </div>
                </div>
            </div>
            <div class="controls">
                <button class="btn btn-ghost" onclick="loadDemo()">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
                    åŠ è½½ç¤ºä¾‹
                </button>
                
                <!-- æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢ -->
                <div class="btn-group">
                    <button class="btn btn-primary" id="btn-format-mode" onclick="setOutputMode('format')">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                        æ ¼å¼åŒ–
                    </button>
                    <button class="btn btn-ghost" id="btn-compress-mode" onclick="setOutputMode('compress')">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                        å‹ç¼©
                    </button>
                </div>
                
                <!-- è½¬ä¹‰/åè½¬ä¹‰ç»„ -->
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="escapeJson()">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12" y1="16" y2="16"/></svg>
                        è½¬ä¹‰
                    </button>
                    <button class="btn btn-primary" onclick="unescapeJson()">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12" y1="16" y2="16"/></svg>
                        åè½¬ä¹‰
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main>
        <!-- åŒæ ç¼–è¾‘å™¨ -->
        <div class="editor-view">
            <!-- å·¦ä¾§ï¼šåŸå§‹è¾“å…¥ -->
            <div class="editor-pane">
                <div class="editor-header">
                    <span>åŸå§‹ JSON</span>
                    <div class="editor-actions">
                        <button class="action-btn-small" onclick="clearInput()" title="æ¸…ç©º">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            æ¸…ç©º
                        </button>
                    </div>
                </div>
                <div class="editor-container" id="input-container">
                    <div class="textarea-wrapper">
                        <div class="line-numbers" id="input-lines">1</div>
                        <div class="code-area">
                            <pre class="code-overlay" id="input-hl"></pre>
                            <textarea id="input" spellcheck="false" placeholder='{"name": "ç¤ºä¾‹", "value": 123}'></textarea>
                        </div>
                    </div>
                    <div class="status-bar">
                        <span id="input-stats">è¡Œæ•°: 1 å­—ç¬¦: 0</span>
                        <span id="input-valid" class="status-valid hidden">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            æœ‰æ•ˆ JSON
                        </span>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ ¼å¼åŒ–ç»“æœ -->
            <div class="editor-pane">
                <div class="editor-header">
                    <span id="output-title">æ ¼å¼åŒ–ç»“æœ</span>
                    <div class="editor-actions">
                        <button class="action-btn-small" onclick="copyOutput()" title="å¤åˆ¶ç»“æœ (Ctrl+C)">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            å¤åˆ¶
                        </button>
                    </div>
                </div>
                <div class="editor-container output-readonly" id="output-container">
                    <!-- é”™è¯¯é¢æ¿ï¼ˆæœ‰é”™è¯¯æ—¶æ˜¾ç¤ºï¼‰ -->
                    <div class="error-panel hidden" id="error-panel"></div>
                    
                    <!-- æ ¼å¼åŒ–ç»“æœï¼ˆæ— é”™è¯¯æ—¶æ˜¾ç¤ºï¼‰ -->
                    <div class="output-content" id="output-content">
                    <div class="textarea-wrapper">
                        <div class="line-numbers" id="output-lines">1</div>
                        <div class="code-area">
                            <pre class="code-overlay" id="output-hl"></pre>
                            <textarea id="output" spellcheck="false" readonly placeholder="æ ¼å¼åŒ–ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
                        </div>
                    </div>
                    <div class="status-bar">
                        <span id="output-stats">è¡Œæ•°: 0 å­—ç¬¦: 0</span>
                        <span id="output-valid" class="status-valid hidden">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            æœ‰æ•ˆ JSON
                        </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="/assets/js/common.js"></script>
    <script>
        const input = document.getElementById('input');
        const inputLines = document.getElementById('input-lines');
        const inputHl = document.getElementById('input-hl');
        const inputStats = document.getElementById('input-stats');
        const inputValid = document.getElementById('input-valid');
        const inputContainer = document.getElementById('input-container');
        
        // å³ä¾§é”™è¯¯é¢æ¿å’Œè¾“å‡ºå†…å®¹
        const errorPanel = document.getElementById('error-panel');
        const outputContent = document.getElementById('output-content');

        const output = document.getElementById('output');
        const outputLines = document.getElementById('output-lines');
        const outputHl = document.getElementById('output-hl');
        const outputStats = document.getElementById('output-stats');
        const outputValid = document.getElementById('output-valid');
        const outputContainer = document.getElementById('output-container');
        const outputTitle = document.getElementById('output-title');

        // è¾“å‡ºæ¨¡å¼ï¼š'format' æˆ– 'compress'
        let outputMode = 'format';

        // é˜²æŠ–å®šæ—¶å™¨
        let validationTimer = null;
        const VALIDATION_DEBOUNCE = 300; // 300ms é˜²æŠ–

        // å½“å‰é”™è¯¯ä¿¡æ¯
        let currentError = null;

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * JSON é”™è¯¯è§£æå™¨ - è§£æ JSON.parse çš„é”™è¯¯ä¿¡æ¯
         * æå–é”™è¯¯ä½ç½®ã€è¡Œå·ã€åˆ—å·å’Œé”™è¯¯ç±»å‹
         */
        function parseJsonError(error, jsonString) {
            const errorInfo = {
                message: error.message,
                line: null,
                column: null,
                position: null,
                type: 'unknown',
                suggestion: ''
            };

            // å°è¯•ä»é”™è¯¯æ¶ˆæ¯ä¸­æå–ä½ç½®ä¿¡æ¯
            // æ ¼å¼: "Unexpected token X in JSON at position Y"
            const positionMatch = error.message.match(/position\s+(\d+)/i);
            if (positionMatch) {
                errorInfo.position = parseInt(positionMatch[1], 10);
                
                // è®¡ç®—è¡Œå·å’Œåˆ—å·
                const textBeforeError = jsonString.substring(0, errorInfo.position);
                const lines = textBeforeError.split('\n');
                errorInfo.line = lines.length;
                errorInfo.column = lines[lines.length - 1].length + 1;
            }

            // è§£æé”™è¯¯ç±»å‹å’Œæä¾›ä¿®å¤å»ºè®®
            const message = error.message.toLowerCase();
            
            if (message.includes('unexpected token')) {
                errorInfo.type = 'unexpected_token';
                const tokenMatch = error.message.match(/unexpected token\s+([^\s]+)/i);
                const token = tokenMatch ? tokenMatch[1] : '';
                
                if (token.includes('}') || token.includes(']')) {
                    errorInfo.suggestion = 'å¯èƒ½ç¼ºå°‘å¼€å§‹ç¬¦å· { æˆ– [ï¼Œæˆ–è€…æœ‰å¤šä½™çš„ç»“æŸç¬¦å·';
                } else if (token.includes('{') || token.includes('[')) {
                    errorInfo.suggestion = 'å¯èƒ½ç¼ºå°‘ç»“æŸç¬¦å· } æˆ– ]ï¼Œæˆ–è€…æœ‰å¤šä½™çš„å¼€å§‹ç¬¦å·';
                } else if (token.includes(',')) {
                    errorInfo.suggestion = 'å¤šä½™çš„é€—å·ï¼Œè¯·æ£€æŸ¥æ˜¯å¦åœ¨å¯¹è±¡æˆ–æ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ å';
                } else if (token.includes(':')) {
                    errorInfo.suggestion = 'å¤šä½™çš„å†’å·ï¼Œè¯·æ£€æŸ¥å¯¹è±¡é”®å€¼å¯¹çš„æ ¼å¼';
                } else {
                    errorInfo.suggestion = 'æ„å¤–çš„å­—ç¬¦ï¼Œè¯·æ£€æŸ¥ JSON è¯­æ³•æ˜¯å¦æ­£ç¡®';
                }
            } else if (message.includes('unexpected end')) {
                errorInfo.type = 'unexpected_end';
                errorInfo.suggestion = 'JSON å­—ç¬¦ä¸²ä¸å®Œæ•´ï¼Œå¯èƒ½ç¼ºå°‘ç»“æŸç¬¦å· } æˆ– ]';
            } else if (message.includes('expected property name')) {
                errorInfo.type = 'expected_property';
                errorInfo.suggestion = 'å¯¹è±¡å±æ€§åå¿…é¡»ç”¨åŒå¼•å·åŒ…è£¹ï¼Œä¾‹å¦‚: "key": value';
            } else if (message.includes('expected double-quoted property name')) {
                errorInfo.type = 'expected_quoted_property';
                errorInfo.suggestion = 'å±æ€§åå¿…é¡»ä½¿ç”¨åŒå¼•å·ï¼Œä¸èƒ½ä½¿ç”¨å•å¼•å·æˆ–çœç•¥å¼•å·';
            } else if (message.includes('bad escaped character')) {
                errorInfo.type = 'bad_escape';
                errorInfo.suggestion = 'è½¬ä¹‰å­—ç¬¦æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥åæ–œæ çš„ä½¿ç”¨';
            } else if (message.includes('bad control character')) {
                errorInfo.type = 'bad_control';
                errorInfo.suggestion = 'åŒ…å«æ— æ•ˆçš„æ§åˆ¶å­—ç¬¦ï¼Œè¯·æ£€æŸ¥å­—ç¬¦ä¸²å†…å®¹';
            } else if (message.includes('unterminated string')) {
                errorInfo.type = 'unterminated_string';
                errorInfo.suggestion = 'å­—ç¬¦ä¸²æœªæ­£ç¡®ç»“æŸï¼Œè¯·æ£€æŸ¥æ˜¯å¦ç¼ºå°‘ç»“æŸå¼•å·';
            } else {
                errorInfo.suggestion = 'è¯·æ£€æŸ¥ JSON è¯­æ³•ï¼Œç¡®ä¿æ‰€æœ‰æ‹¬å·ã€å¼•å·éƒ½æ­£ç¡®åŒ¹é…';
            }

            return errorInfo;
        }

        /**
         * é«˜äº®é”™è¯¯è¡Œå’Œé”™è¯¯å­—ç¬¦
         */
        function highlightErrorLine(lineNumber, columnNumber = null) {
            // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
            const prevErrorLines = document.querySelectorAll('.error-line, .error-char');
            prevErrorLines.forEach(el => {
                el.classList.remove('error-line', 'error-char');
            });

            if (!lineNumber || lineNumber < 1) return;

            const lines = input.value.split('\n');
            const errorLine = lines[lineNumber - 1];
            if (!errorLine) return;

            // é«˜äº®è¡Œå·
            const lineNumberEls = inputLines.querySelectorAll('div');
            if (lineNumberEls[lineNumber - 1]) {
                lineNumberEls[lineNumber - 1].classList.add('error-line');
            }

            // é‡æ–°ç”Ÿæˆé«˜äº®ä»£ç 
            let highlighted = highlightJson(input.value);
            const highlightedLines = highlighted.split('\n');
            
            // ä¸ºé”™è¯¯è¡Œæ·»åŠ é«˜äº®ç±»
            if (highlightedLines[lineNumber - 1] !== undefined) {
                let errorLineContent = highlightedLines[lineNumber - 1] || '';
                
                // å¦‚æœæœ‰åˆ—å·ï¼Œå°è¯•æ ‡è®°é”™è¯¯å­—ç¬¦
                // æ³¨æ„ï¼šç”±äºHTMLé«˜äº®æ ‡ç­¾çš„å­˜åœ¨ï¼Œç²¾ç¡®å®šä½å­—ç¬¦ä½ç½®æ¯”è¾ƒå¤æ‚
                // æˆ‘ä»¬é‡‡ç”¨ç®€åŒ–æ–¹æ¡ˆï¼šé«˜äº®æ•´è¡Œï¼Œé”™è¯¯å­—ç¬¦ä¼šåœ¨é”™è¯¯æç¤ºä¸­æ˜¾ç¤º
                // å¦‚æœéœ€è¦æ›´ç²¾ç¡®çš„æ ‡è®°ï¼Œå¯ä»¥åœ¨é”™è¯¯ä½ç½®é™„è¿‘æ·»åŠ è§†è§‰æç¤º
                if (columnNumber && columnNumber > 0 && columnNumber <= errorLine.length) {
                    const errorChar = errorLine[columnNumber - 1] || '';
                    // é”™è¯¯å­—ç¬¦ä¿¡æ¯å·²é€šè¿‡é”™è¯¯æç¤ºæ˜¾ç¤ºï¼Œè¿™é‡Œä¸»è¦é«˜äº®æ•´è¡Œ
                    // å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¡Œå°¾æ·»åŠ ä¸€ä¸ªé”™è¯¯æ ‡è®°
                }
                
                highlightedLines[lineNumber - 1] = `<span class="error-line">${errorLineContent}</span>`;
            }
            
            inputHl.innerHTML = highlightedLines.join('<br/>') + '<br/>';

            // æ»šåŠ¨åˆ°é”™è¯¯è¡Œï¼ˆå»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿ DOM å·²æ›´æ–°ï¼‰
            setTimeout(() => {
                if (lineNumber > 0) {
                    const lineHeight = 24; // 1.5rem = 24px
                    const scrollTop = (lineNumber - 1) * lineHeight - 100; // æå‰ 100px æ˜¾ç¤º
                    input.scrollTop = Math.max(0, scrollTop);
                    inputLines.scrollTop = input.scrollTop;
                }
            }, 50);
        }

        // JSON è¯­æ³•é«˜äº®
        function highlightJson(code) {
            if (!code) return '';
            return code.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, (match) => {
                let cls = 'hl-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'hl-key';
                    } else {
                        cls = 'hl-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'hl-bool';
                } else if (/null/.test(match)) {
                    cls = 'hl-null';
                }
                return `<span class="${cls}">${escapeHtml(match)}</span>`;
            });
        }

        /**
         * æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯ - å³ä¾§æ˜¾ç¤ºï¼Œç°ä»£åŒ–UIè®¾è®¡
         */
        function showDetailedError(errorInfo) {
            currentError = errorInfo;
            
            let errorHtml = '<div class="error-card">';
            
            // é”™è¯¯å¤´éƒ¨
            errorHtml += '<div class="error-header">';
            errorHtml += '<div class="error-icon-wrapper">';
            errorHtml += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">';
            errorHtml += '<circle cx="12" cy="12" r="10"/>';
            errorHtml += '<line x1="12" y1="8" x2="12" y2="12"/>';
            errorHtml += '<line x1="12" y1="16" x2="12.01" y2="16"/>';
            errorHtml += '</svg>';
            errorHtml += '</div>';
            
            errorHtml += '<div class="error-title-section">';
            errorHtml += '<div class="error-title">';
            errorHtml += '<span>JSON è¯­æ³•é”™è¯¯</span>';
            if (errorInfo.line) {
                errorHtml += `<span class="error-location-badge">`;
                errorHtml += `<svg style="width: 0.75rem; height: 0.75rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`;
                errorHtml += ` ç¬¬ ${errorInfo.line} è¡Œ`;
                if (errorInfo.column) {
                    errorHtml += `:${errorInfo.column}`;
                }
                errorHtml += '</span>';
            }
            errorHtml += '</div>';
            errorHtml += '</div>';
            errorHtml += '</div>';
            
            // é”™è¯¯ä¸»ä½“
            errorHtml += '<div class="error-body">';
            
            // é”™è¯¯æ¶ˆæ¯
            errorHtml += '<div class="error-message">';
            errorHtml += escapeHtml(errorInfo.message);
            errorHtml += '</div>';
            
            // ä¿®å¤å»ºè®®ï¼ˆå¯æŠ˜å ï¼‰
            if (errorInfo.suggestion) {
                errorHtml += '<div class="error-suggestion expanded" id="error-suggestion">';
                errorHtml += '<div class="error-suggestion-header" onclick="toggleSuggestion()">';
                errorHtml += '<div class="error-suggestion-title">';
                errorHtml += '<svg class="error-suggestion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>';
                errorHtml += '<span>ğŸ’¡ ä¿®å¤å»ºè®®</span>';
                errorHtml += '</div>';
                errorHtml += '</div>';
                errorHtml += '<div class="error-suggestion-content">';
                errorHtml += '<div class="error-suggestion-text">';
                errorHtml += escapeHtml(errorInfo.suggestion);
                errorHtml += '</div>';
                errorHtml += '<button class="error-action-btn" onclick="jumpToError()">';
                errorHtml += '<svg style="width: 0.875rem; height: 0.875rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>';
                errorHtml += 'è·³è½¬åˆ°é”™è¯¯ä½ç½®';
                errorHtml += '</button>';
                errorHtml += '</div>';
                errorHtml += '</div>';
            }
            
            errorHtml += '</div>';
            errorHtml += '</div>';
            
            // æ˜¾ç¤ºåœ¨å³ä¾§é”™è¯¯é¢æ¿
            errorPanel.innerHTML = errorHtml;
            errorPanel.classList.remove('hidden');
            outputContent.classList.add('hidden');
            
            // æ›´æ–°å³ä¾§æ ‡é¢˜
            outputTitle.textContent = 'é”™è¯¯è¯¦æƒ…';
            
            // å·¦ä¾§å®¹å™¨æ·»åŠ é”™è¯¯çŠ¶æ€
            inputContainer.classList.add('error');
            
            // é«˜äº®é”™è¯¯è¡Œå’Œé”™è¯¯å­—ç¬¦
            highlightErrorLine(errorInfo.line, errorInfo.column);
        }

        // åˆ‡æ¢ä¿®å¤å»ºè®®å±•å¼€/æŠ˜å 
        function toggleSuggestion() {
            const suggestionEl = document.getElementById('error-suggestion');
            if (suggestionEl) {
                suggestionEl.classList.toggle('expanded');
            }
        }

        // è·³è½¬åˆ°é”™è¯¯ä½ç½®
        function jumpToError() {
            if (currentError && currentError.line) {
                highlightErrorLine(currentError.line, currentError.column);
                input.focus();
                
                // å¦‚æœé”™è¯¯ä½ç½®å·²çŸ¥ï¼Œç§»åŠ¨å…‰æ ‡
                if (currentError.position !== null) {
                    input.setSelectionRange(currentError.position, currentError.position + 1);
                }
            }
        }

        /**
         * æ¸…é™¤é”™è¯¯æ˜¾ç¤º
         * @param {boolean} restoreTitle - æ˜¯å¦æ¢å¤é»˜è®¤æ ‡é¢˜ï¼ˆæ ¼å¼åŒ–/å‹ç¼©ç»“æœï¼‰
         */
        function clearError(restoreTitle = true) {
            currentError = null;
            errorPanel.classList.add('hidden');
            outputContent.classList.remove('hidden');
            inputContainer.classList.remove('error');
            
            // æ¢å¤å³ä¾§æ ‡é¢˜ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (restoreTitle) {
                if (outputMode === 'format') {
                    outputTitle.textContent = 'æ ¼å¼åŒ–ç»“æœ';
                } else {
                    outputTitle.textContent = 'å‹ç¼©ç»“æœ';
                }
            }
            
            // æ¸…é™¤é”™è¯¯è¡Œé«˜äº®
            const prevErrorLines = document.querySelectorAll('.error-line');
            prevErrorLines.forEach(el => {
                el.classList.remove('error-line');
            });
        }

        /**
         * æ‰§è¡Œ JSON éªŒè¯ï¼ˆå¸¦é˜²æŠ–ï¼‰
         */
        function validateJson() {
            const val = input.value;
            const lineCount = val.split('\n').length;
            
            // æ›´æ–°è¡Œå·å’Œç»Ÿè®¡
            inputLines.innerHTML = Array.from({length: lineCount}, (_, i) => `<div>${i+1}</div>`).join('');
            inputStats.textContent = `è¡Œæ•°: ${lineCount} å­—ç¬¦: ${val.length}`;
            
            // éªŒè¯ JSON
            if (!val.trim()) {
                inputValid.classList.add('hidden');
                clearError();
                // æ›´æ–°è¯­æ³•é«˜äº®ï¼ˆæ— é”™è¯¯æ—¶ï¼‰
                inputHl.innerHTML = highlightJson(val) + '<br/>';
                updateOutput(''); // æ¸…ç©ºè¾“å‡º
                return;
            }
            
            try {
                JSON.parse(val);
                // éªŒè¯æˆåŠŸ
                inputValid.classList.remove('hidden');
                clearError();
                // æ›´æ–°è¯­æ³•é«˜äº®ï¼ˆæ— é”™è¯¯æ—¶ï¼‰
                inputHl.innerHTML = highlightJson(val) + '<br/>';
                // è‡ªåŠ¨æ›´æ–°è¾“å‡º
                updateOutputFromInput();
            } catch (e) {
                // éªŒè¯å¤±è´¥
                inputValid.classList.add('hidden');
                const errorInfo = parseJsonError(e, val);
                showDetailedError(errorInfo);
                updateOutput(''); // æ¸…ç©ºè¾“å‡º
            }
        }

        // æ›´æ–°è¾“å…¥åŒºåŸŸï¼ˆå¸¦é˜²æŠ–ï¼‰
        function updateInput() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (validationTimer) {
                clearTimeout(validationTimer);
            }
            
            // ç«‹å³æ›´æ–°è¡Œå·å’Œç»Ÿè®¡ï¼ˆä¸éœ€è¦é˜²æŠ–ï¼‰
            const val = input.value;
            const lineCount = val.split('\n').length;
            inputLines.innerHTML = Array.from({length: lineCount}, (_, i) => `<div>${i+1}</div>`).join('');
            inputStats.textContent = `è¡Œæ•°: ${lineCount} å­—ç¬¦: ${val.length}`;
            
            // ç«‹å³æ›´æ–°è¯­æ³•é«˜äº®ï¼ˆä¸éœ€è¦é˜²æŠ–ï¼‰
            inputHl.innerHTML = highlightJson(val) + '<br/>';
            
            // é˜²æŠ–éªŒè¯ JSON
            validationTimer = setTimeout(() => {
                validateJson();
            }, VALIDATION_DEBOUNCE);
        }

        // æ›´æ–°è¾“å‡ºåŒºåŸŸ
        function updateOutput(content) {
            const lineCount = content ? content.split('\n').length : 0;
            
            output.value = content;
            outputLines.innerHTML = Array.from({length: lineCount}, (_, i) => `<div>${i+1}</div>`).join('');
            outputHl.innerHTML = content ? highlightJson(content) + '<br/>' : '';
            outputStats.textContent = `è¡Œæ•°: ${lineCount} å­—ç¬¦: ${content.length}`;
            
            // éªŒè¯è¾“å‡º JSON
            if (!content.trim()) {
                outputValid.classList.add('hidden');
                return;
            }
            
            try {
                JSON.parse(content);
                outputValid.classList.remove('hidden');
            } catch (e) {
                outputValid.classList.add('hidden');
            }
        }

        // æ ¹æ®è¾“å…¥æ›´æ–°è¾“å‡ºï¼ˆæ ¹æ®å½“å‰æ¨¡å¼ï¼‰
        function updateOutputFromInput() {
            const val = input.value.trim();
            if (!val) {
                updateOutput('');
                return;
            }

            try {
                let jsonStr = val;
                
                // å…ˆå°è¯•æ ‡å‡† JSON è§£æ
                try {
                    const obj = JSON.parse(jsonStr);
                    let result;
                    if (outputMode === 'format') {
                        result = JSON.stringify(obj, null, 2);
                        outputTitle.textContent = 'æ ¼å¼åŒ–ç»“æœ';
                    } else {
                        result = JSON.stringify(obj);
                        outputTitle.textContent = 'å‹ç¼©ç»“æœ';
                    }
                    updateOutput(result);
                    return;
                } catch (e1) {
                    // å¦‚æœæ ‡å‡†è§£æå¤±è´¥ï¼Œå°è¯•åè½¬ä¹‰
                    if (val.startsWith('"') && val.endsWith('"')) {
                        try {
                            jsonStr = JSON.parse(val);
                            const obj = JSON.parse(jsonStr);
                            let result;
                            if (outputMode === 'format') {
                                result = JSON.stringify(obj, null, 2);
                                outputTitle.textContent = 'æ ¼å¼åŒ–ç»“æœ';
                            } else {
                                result = JSON.stringify(obj);
                                outputTitle.textContent = 'å‹ç¼©ç»“æœ';
                            }
                            updateOutput(result);
                            return;
                        } catch (e2) {
                            // ç»§ç»­å°è¯•æ–¹æ³•2
                        }
                    }
                    
                    // æ–¹æ³•2: æ‰‹åŠ¨æ›¿æ¢è½¬ä¹‰çš„å¼•å·
                    jsonStr = val.replace(/\\"/g, '"').replace(/\\\\/g, '\\');
                    try {
                        const obj = JSON.parse(jsonStr);
                        let result;
                        if (outputMode === 'format') {
                            result = JSON.stringify(obj, null, 2);
                            outputTitle.textContent = 'æ ¼å¼åŒ–ç»“æœ';
                        } else {
                            result = JSON.stringify(obj);
                            outputTitle.textContent = 'å‹ç¼©ç»“æœ';
                        }
                        updateOutput(result);
                        return;
                    } catch (e3) {
                        updateOutput(''); // è§£æå¤±è´¥ï¼Œæ¸…ç©ºè¾“å‡º
                    }
                }
            } catch (e) {
                updateOutput(''); // è§£æå¤±è´¥ï¼Œæ¸…ç©ºè¾“å‡º
            }
        }

        // è®¾ç½®è¾“å‡ºæ¨¡å¼
        function setOutputMode(mode) {
            outputMode = mode;
            const btnFormat = document.getElementById('btn-format-mode');
            const btnCompress = document.getElementById('btn-compress-mode');
            
            if (mode === 'format') {
                btnFormat.className = 'btn btn-primary';
                btnCompress.className = 'btn btn-ghost';
            } else {
                btnFormat.className = 'btn btn-ghost';
                btnCompress.className = 'btn btn-primary';
            }
            
            updateOutputFromInput();
        }


        // åŒæ­¥æ»šåŠ¨
        input.addEventListener('scroll', () => {
            inputLines.scrollTop = input.scrollTop;
            inputHl.scrollTop = input.scrollTop;
            inputHl.scrollLeft = input.scrollLeft;
        });

        output.addEventListener('scroll', () => {
            outputLines.scrollTop = output.scrollTop;
            outputHl.scrollTop = output.scrollTop;
            outputHl.scrollLeft = output.scrollLeft;
        });

        input.addEventListener('input', updateInput);
        
        // åˆå§‹åŒ–éªŒè¯
        validateJson();
        
        // ç‚¹å‡»é”™è¯¯é¢æ¿å¯è·³è½¬åˆ°é”™è¯¯ä½ç½®ï¼ˆå§”æ‰˜äº‹ä»¶å¤„ç†ï¼‰
        errorPanel.addEventListener('click', (e) => {
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯æŒ‰é’®æˆ–å¯æŠ˜å æ ‡é¢˜ï¼Œåˆ™è·³è½¬
            if (!e.target.closest('button') && !e.target.closest('.error-suggestion-header')) {
                jumpToError();
            }
        });

        // è½¬ä¹‰ JSON å­—ç¬¦ä¸²ï¼ˆæ˜¾ç¤ºåœ¨å³ä¾§ï¼Œä¸ä¿®æ”¹å·¦ä¾§åŸå§‹å†…å®¹ï¼‰
        function escapeJson() {
            const val = input.value.trim();
            if (!val) {
                showError('input', 'è¯·è¾“å…¥å†…å®¹');
                return;
            }

            try {
                // å°†å†…å®¹è½¬ä¹‰ä¸º JSON å­—ç¬¦ä¸²æ ¼å¼ï¼Œæ˜¾ç¤ºåœ¨å³ä¾§
                const escaped = JSON.stringify(val);
                outputTitle.textContent = 'è½¬ä¹‰ç»“æœ';
                updateOutput(escaped);
                // æ¸…é™¤é”™è¯¯çŠ¶æ€ï¼Œä½†ä¿ç•™æ ‡é¢˜ï¼ˆä¸æ¢å¤ä¸ºé»˜è®¤æ ‡é¢˜ï¼‰
                clearError(false);
                showNotification('å·²è½¬ä¹‰', 'success');
            } catch (e) {
                showError('input', `è½¬ä¹‰å¤±è´¥: ${e.message}`);
            }
        }

        // åè½¬ä¹‰ JSON å­—ç¬¦ä¸²ï¼ˆæ˜¾ç¤ºåœ¨å³ä¾§ï¼Œä¸ä¿®æ”¹å·¦ä¾§åŸå§‹å†…å®¹ï¼‰
        function unescapeJson() {
            const val = input.value.trim();
            if (!val) {
                showError('input', 'è¯·è¾“å…¥è½¬ä¹‰çš„å­—ç¬¦ä¸²');
                return;
            }

            try {
                let unescaped = val;
                
                // æ–¹æ³•1: å°è¯•æ ‡å‡† JSON è§£æï¼ˆå¦‚æœæ•´ä¸ªå­—ç¬¦ä¸²è¢«åŒå¼•å·åŒ…è£¹ï¼‰
                if (val.startsWith('"') && val.endsWith('"')) {
                    try {
                        unescaped = JSON.parse(val);
                        outputTitle.textContent = 'åè½¬ä¹‰ç»“æœ';
                        updateOutput(unescaped);
                        // æ¸…é™¤é”™è¯¯çŠ¶æ€ï¼Œä½†ä¿ç•™æ ‡é¢˜ï¼ˆä¸æ¢å¤ä¸ºé»˜è®¤æ ‡é¢˜ï¼‰
                        clearError(false);
                        showNotification('å·²åè½¬ä¹‰', 'success');
                        return;
                    } catch (e) {
                        // å¦‚æœæ ‡å‡†è§£æå¤±è´¥ï¼Œç»§ç»­å°è¯•æ–¹æ³•2
                    }
                }
                
                // æ–¹æ³•2: æ‰‹åŠ¨æ›¿æ¢è½¬ä¹‰çš„å¼•å·ï¼ˆå¤„ç† {\"name\":...} è¿™ç§æ ¼å¼ï¼‰
                // æ›¿æ¢ \" ä¸º "
                unescaped = val.replace(/\\"/g, '"');
                // æ›¿æ¢ \\ ä¸º \ï¼ˆä½†è¦å°å¿ƒï¼Œé¿å…è¿‡åº¦æ›¿æ¢ï¼‰
                unescaped = unescaped.replace(/\\\\/g, '\\');
                
                // éªŒè¯ç»“æœæ˜¯å¦æ˜¯æœ‰æ•ˆçš„ JSON
                try {
                    JSON.parse(unescaped);
                    outputTitle.textContent = 'åè½¬ä¹‰ç»“æœ';
                    updateOutput(unescaped);
                    // æ¸…é™¤é”™è¯¯çŠ¶æ€ï¼Œä½†ä¿ç•™æ ‡é¢˜ï¼ˆä¸æ¢å¤ä¸ºé»˜è®¤æ ‡é¢˜ï¼‰
                    clearError(false);
                    showNotification('å·²åè½¬ä¹‰', 'success');
                    return;
                } catch (e2) {
                    // å¦‚æœæ›¿æ¢åä»ç„¶ä¸æ˜¯æœ‰æ•ˆ JSONï¼Œå°è¯•å…¶ä»–è½¬ä¹‰å­—ç¬¦
                    unescaped = unescaped
                        .replace(/\\n/g, '\n')
                        .replace(/\\r/g, '\r')
                        .replace(/\\t/g, '\t')
                        .replace(/\\f/g, '\f')
                        .replace(/\\b/g, '\b');
                    
                    // å†æ¬¡éªŒè¯
                    try {
                        JSON.parse(unescaped);
                        outputTitle.textContent = 'åè½¬ä¹‰ç»“æœ';
                        updateOutput(unescaped);
                        // æ¸…é™¤é”™è¯¯çŠ¶æ€ï¼Œä½†ä¿ç•™æ ‡é¢˜ï¼ˆä¸æ¢å¤ä¸ºé»˜è®¤æ ‡é¢˜ï¼‰
                        clearError(false);
                        showNotification('å·²åè½¬ä¹‰', 'success');
                        return;
                    } catch (e3) {
                        throw new Error('æ— æ³•è§£æä¸ºæœ‰æ•ˆçš„ JSONã€‚è¯·æ£€æŸ¥è¾“å…¥æ ¼å¼');
                    }
                }
            } catch (e) {
                showError('input', `åè½¬ä¹‰å¤±è´¥: ${e.message}ã€‚è¯·ç¡®ä¿è¾“å…¥çš„æ˜¯æœ‰æ•ˆçš„è½¬ä¹‰ JSON å­—ç¬¦ä¸²`);
            }
        }

        // æ ¼å¼åŒ–/å‹ç¼©åŠŸèƒ½å·²æ”¹ä¸ºå®æ—¶æ›´æ–°ï¼Œé€šè¿‡ setOutputMode åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼

        // æ¸…ç©ºè¾“å…¥
        function clearInput() {
            input.value = '';
            updateInput();
            inputContainer.classList.remove('error');
            clearError(); // æ¸…é™¤é”™è¯¯æ˜¾ç¤º
        }

        // å¤åˆ¶è¾“å‡ºç»“æœ
        async function copyOutput() {
            const val = output.value.trim();
            if (!val) {
                showNotification('æ²¡æœ‰å†…å®¹å¯å¤åˆ¶', 'warning');
                return;
            }
            const success = await copyToClipboard(val);
            if (success) {
                showNotification('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            } else {
                showNotification('å¤åˆ¶å¤±è´¥', 'error');
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ï¼ˆå…¼å®¹æ—§æ¥å£ï¼‰
        function showError(container, msg) {
            if (container === 'input') {
                const errorInfo = {
                    message: msg,
                    line: null,
                    column: null,
                    type: 'custom',
                    suggestion: ''
                };
                showDetailedError(errorInfo);
            }
        }

        // åŠ è½½ç¤ºä¾‹
        function loadDemo() {
            const demo = {
                name: "ç¤ºä¾‹æ•°æ®",
                version: "1.0.0",
                features: ["æ ¼å¼åŒ–", "å‹ç¼©", "ç¾åŒ–"],
                settings: {
                    theme: "dark",
                    language: "zh-CN",
                    autoSave: true
                },
                tags: ["JSON", "å·¥å…·", "å®ç”¨"],
                metadata: {
                    created: "2024-01-01",
                    updated: "2024-01-02",
                    author: "å·¥å…·é›†åˆ"
                }
            };
            input.value = JSON.stringify(demo, null, 2);
            updateInput();
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + Enter: åˆ‡æ¢ä¸ºæ ¼å¼åŒ–æ¨¡å¼
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                setOutputMode('format');
            }
            // Ctrl/Cmd + Shift + Enter: åˆ‡æ¢ä¸ºå‹ç¼©æ¨¡å¼
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'Enter') {
                e.preventDefault();
                setOutputMode('compress');
            }
            // Ctrl/Cmd + C: å¤åˆ¶è¾“å‡ºï¼ˆå½“ç„¦ç‚¹ä¸åœ¨è¾“å…¥æ¡†æ—¶ï¼‰
            if ((e.ctrlKey || e.metaKey) && e.key === 'c' && document.activeElement !== input) {
                e.preventDefault();
                copyOutput();
            }
            // F2 æˆ– Ctrl/Cmd + G: è·³è½¬åˆ°é”™è¯¯ä½ç½®ï¼ˆå¦‚æœæœ‰é”™è¯¯ï¼‰
            if ((e.key === 'F2' || ((e.ctrlKey || e.metaKey) && e.key === 'g')) && currentError && currentError.line) {
                e.preventDefault();
                highlightErrorLine(currentError.line);
                input.focus();
            }
        });
    </script>
</body>
</html>

